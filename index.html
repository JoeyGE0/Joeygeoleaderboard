<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <h1 class="top-bar">
        <span style="color: #ffffff;">
            <strong>&nbsp; &nbsp;<span style="font-size: 13px;" class="custom-text">On Your Marks, Get Set Go!</span></strong>
        </span>
    </h1>
    
    <title>Leaderboard</title>
    <link rel="stylesheet" href="style.css">
    <style>

.top-bar {
            background-color: #007bff;
            height: 50px;
            margin: 0; /* Remove default margin */
            border-radius: 0; /* Remove border-radius to make it straight to the edge */
            padding: 0; /* Remove padding to make it flush with the edges */
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
        }
        
        .custom-text {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 14px;
            letter-spacing: .020em;
            font-family: SF Pro Display, SF Pro Icons, Helvetica Neue, Helvetica, Arial, sans-serif;
            font-weight: 550;
            color: #ffffff;
            cursor: pointer;
        }

        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }

        h1, h2 {
            color: #333;
            padding-top: 20px;
            padding-bottom: 20px;
        }

        button {
    background-color: #5e4dcd;
    color: white;
    padding: 7px 15px; /* Keep this as is */
    border: none;
    cursor: pointer;
    margin-top: 10px;
    border-radius: 0 6px 6px 0;
}

input {
    padding: 7px 15px; /* Set padding to match the button */
    margin: 5px;
    margin-right: -4px;
    border-radius: 4px;
    font-size: 12px;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    border: 1px solid #5e4dcd;
    border-radius: 6px 0 0 6px;
    background-color: transparent;
    transition: background-color .3s ease-in-out;
}

button:hover {
    background-color: #5e5dcd;
}



        ol {
            list-style-type: none;
            padding: 0;
        }

        li {
            background-color: #f7f7f7;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
        }

        /* Style for the greyed-out button */
        button[disabled] {
            background-color: grey;
            cursor: not-allowed; /* Change the cursor to a "not-allowed" symbol */
        }

        #resetButton {
            background-color: #ff3333;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <h1>Leaderboard</h1>
    <div style="display: inline-block;">
        <input type="text" id="nameInput" placeholder="Enter Your Geo-Name">
        <button onclick="addEntry()" title="Click to Add to Leaderboard">Add to Leaderboard</button>

    </div>
    <div id="leaderboard">
        <h2>Top Times</h2>
        <ol id="leaderList">
            <!-- Leaderboard entries will go here -->
        </ol>
    </div>
    


    <input type="text" id="manualTimeInput" placeholder="Enter time (seconds)">
    <button onclick="addManualTime()" title="Manual Time">Manual Time</button>
    


<input type="number" id="timeLimitInput" value="30" min="1"  placeholder="Default: 30(min)">
<button onclick="setDisqualificationTimeLimit()" title="Max Allowed time" >Set Limit</button>
<button id="resetButton" onclick="resetMemory()">Reset Board</button>
<div id="leaderboard">
    <ol id="leaderList">
        <!-- Leaderboard entries will go here -->
    </ol>
</div>


<div id="disqualifiedSection" style="display: none;">
    <h2>You Have Been Disqualified!</h2>
    <h6>Please Enter Name And Try Again</h6>
    <ul id="disqualifiedList">
        <!-- Disqualified entries will go here -->
    </ul>
</div>


    <script>
const leaderboard = document.getElementById('leaderList');
const nameInput = document.getElementById('nameInput');
const addButton = document.querySelector('button');
const esp32DataInput = document.getElementById('esp32Data');
const esp32Button = document.getElementById('esp32Button');
const manualTimeInput = document.getElementById('manualTimeInput');
const manualTimeButton = document.getElementById('manualTimeButton');
const timeLimitInput = document.getElementById('timeLimitInput');
const disqualifiedSection = document.getElementById('disqualifiedSection');
const disqualifiedList = document.getElementById('disqualifiedList');

let disqualificationTimeLimit = 30 * 60; // Default to 30 minutes in seconds

// Check if a name is already stored in local storage
let storedName = localStorage.getItem('leaderboardName');

if (storedName) {
    // If a name is found, enable the input for a new name
    nameInput.value = storedName;
    addButton.disabled = false;
    nameInput.disabled = true;
    addButton.style.backgroundColor = 'grey'; // Change the button color to grey
} else {
    // If no name is found, enable the input for a new name
    nameInput.disabled = false;
    addButton.disabled = false;
}

// Check if leaderboard data is already stored in local storage
const storedLeaderboard = localStorage.getItem('leaderboardData');

// Initialize the leaderboard with the stored data or an empty array
const leaderboardData = storedLeaderboard ? JSON.parse(storedLeaderboard) : [];

// Check if disqualified names are stored in local storage
const storedDisqualifiedNames = localStorage.getItem('disqualifiedNames');

// Initialize the disqualified names with the stored data or an empty array
const disqualifiedNames = storedDisqualifiedNames ? JSON.parse(storedDisqualifiedNames) : [];

// Update the leaderboard display based on the stored data
for (const entryData of leaderboardData) {
    const entry = document.createElement('li');
    const formattedTime = entryData.time.startsWith('time: ') ? entryData.time : `time: ${entryData.time}`;
    entry.innerHTML = `<strong>${entryData.name}</strong>: ${formattedTime}`;
    leaderboard.appendChild(entry);
}

// Remove disqualified names from the main leaderboard during initialization
for (const disqualifiedName of disqualifiedNames) {
    const mainLeaderboardEntries = leaderboard.querySelectorAll('li');
    for (const entry of mainLeaderboardEntries) {
        const entryName = entry.querySelector('strong').textContent;
        if (entryName === disqualifiedName) {
            entry.remove();
            break;
        }
    }
}

function addEntry() {
    const name = nameInput.value.trim();

    if (name === '') {
        alert('Please enter a name.');
        return;
    }

    const entry = document.createElement('li');
    entry.innerHTML = `<strong>${name}</strong>: Waiting for data..`;

    leaderboard.appendChild(entry);

    // Store the entered name in local storage
    localStorage.setItem('leaderboardName', name);

    // Disable the input and change the button color to grey after adding the name
    nameInput.disabled = true;
    addButton.disabled = true;
    addButton.style.backgroundColor = 'grey'; // Change the button color to grey

    // Clear input field
    nameInput.value = '';

    // Add the entry data to the leaderboard data
    const entryData = { name, time: 'N/A' };
    leaderboardData.push(entryData);

    // Update the stored leaderboard data
    localStorage.setItem('leaderboardData', JSON.stringify(leaderboardData));
}

function updateEntry(name, time) {
    const entries = leaderboard.querySelectorAll('li');

    // Find the entry with the matching name and update it
    for (const entry of entries) {
        const entryName = entry.querySelector('strong').textContent;
        if (entryName === name) {
            // Check if the entry already has a "time: " prefix
            if (time.startsWith('time: ')) {
                entry.innerHTML = `<strong>${name}</strong>: ${time}`;
            } else {
                entry.innerHTML = `<strong>${name}</strong>: time: ${time}`;
            }
            break;
        }
    }

    // Update the leaderboard data with the received time
    const updatedEntry = leaderboardData.find((entryData) => entryData.name === name);
    if (updatedEntry) {
        updatedEntry.time = time;

        // Update the stored leaderboard data
        localStorage.setItem('leaderboardData', JSON.stringify(leaderboardData));
    }

    // Check if the time exceeds the disqualification time limit
    if (time.startsWith('time: ')) {
        const timeInSeconds = parseInt(time.split(' ')[1]);
        if (timeInSeconds > disqualificationTimeLimit) {
            // Disqualify the user and display the reason
            disqualifyUser(name, 'over the time limit', disqualificationTimeLimit);
        }
    }
}

// Simulate receiving data from the ESP32 and update the leaderboard
function simulateESP32() {
    const esp32Data = esp32DataInput.value.trim();

    if (esp32Data === '') {
        alert('Please enter ESP32 data.');
        return;
    }

    // Assuming you have a function to process the ESP32 data and get the time
    // For example, let's say you have a function called processDataFromESP32
    const timeFromESP32 = processDataFromESP32(esp32Data);

    if (timeFromESP32 !== null) {
        // Get the user's name from local storage
        const userName = localStorage.getItem('leaderboardName');

        if (userName) {
            // Update the leaderboard with the received time for the user
            updateEntry(userName, timeFromESP32);
        } else {
            alert('No user name found. Please enter your name first.');
        }

        esp32DataInput.value = ''; // Clear the input field
    } else {
        alert('Invalid ESP32 data. Please check the format.');
    }
}

// Handle manual time entry
function addManualTime() {
    const time = manualTimeInput.value.trim();

    if (time === '') {
        alert('Please enter a time.');
        return;
    }

    // Get the user's name from local storage
    const userName = localStorage.getItem('leaderboardName');

    if (userName) {
        // Update the leaderboard with the manually entered time for the user
        const formattedTime = time.startsWith('time: ') ? time : `time: ${time}`;
        updateEntry(userName, formattedTime);
        manualTimeInput.value = ''; // Clear the input field
    } else {
        alert('No user name found. Please enter your name first.');
    }
}

// Set the disqualification time limit
function setDisqualificationTimeLimit() {
    const newLimit = parseInt(timeLimitInput.value);
    if (!isNaN(newLimit) && newLimit >= 1) {
        disqualificationTimeLimit = newLimit * 60; // Convert minutes to seconds
        alert(`Disqualification time limit set to ${newLimit} minutes.`);
    } else {
        alert('Please enter a valid time limit (in minutes).');
    }
}

function disqualifyUser(name, reason, timeLimit) {
    const entry = document.createElement('li');
    entry.innerHTML = `<strong>${name}</strong>: Disqualified (${reason}, Time Limit: ${timeLimit / 60} minutes)`;
    disqualifiedList.appendChild(entry);
    // Display the disqualified section
    disqualifiedSection.style.display = 'block';

    // Remove the user's entry from the main leaderboard
    const mainLeaderboardEntries = leaderboard.querySelectorAll('li');
    for (const entry of mainLeaderboardEntries) {
        const entryName = entry.querySelector('strong').textContent;
        if (entryName === name) {
            entry.remove();
            break;
        }
    }

    // Allow the user to enter a new name
    nameInput.disabled = false;
    addButton.disabled = false;
    addButton.style.backgroundColor = '';
    localStorage.removeItem('leaderboardName'); // Clear the stored name

    // Store the disqualified name in local storage
    disqualifiedNames.push(name);
    localStorage.setItem('disqualifiedNames', JSON.stringify(disqualifiedNames)); // Save disqualified names

    // Update the leaderboard data after removing the disqualified name
    const updatedLeaderboardData = leaderboardData.filter((entryData) => entryData.name !== name);
    leaderboardData.length = 0;
    leaderboardData.push(...updatedLeaderboardData);
    localStorage.setItem('leaderboardData', JSON.stringify(leaderboardData)); // Update leaderboard data

// Check if the time exceeds the disqualification time limit and display the user's name
if (timeLimit !== undefined && timeLimit !== null) {
    if (timeLimit <= 0) {
        alert(`Time Limit reached! User: "${name}" has been disqualified.`);
    } else {
        alert(`User: "${name}" is disqualified due to: ${reason}. You exceeded timeout time of ${timeLimit} seconds.`);
    }
 }

}

// This is a placeholder function; replace it with your actual ESP32 data processing logic
function processDataFromESP32(data) {
    // Here, you should parse the data and extract the time
    // For example, if your data format is 'time=XX', you can do something like this:
    const timeMatch = data.match(/time=(\d+)/);
    if (timeMatch) {
        const timeInSeconds = parseInt(timeMatch[1]);
        return `time: ${timeInSeconds}`;
    }
    return null; // Return null if the data format is invalid
}

function resetMemory() {
    // Clear the name from local storage
    localStorage.removeItem('leaderboardName');

    // Alert
    const userConfirmed = window.confirm("ARE YOU SURE YOU WANT TO CLEAR STORAGE! THIS CANNOT BE UNDONE!");
    
    // Check if the user clicked "Cancel"
    if (userConfirmed) {
        // User clicked "OK" or closed the dialog
        alert("Deleting...");
        // Clear the leaderboard data from local storage
        localStorage.removeItem('leaderboardData');
        // Clear disqualified names from local storage
        localStorage.removeItem('disqualifiedNames');
        // Refresh the page to clear the displayed data
        location.reload();
    }
}

    </script>

    
</body>
</html>
